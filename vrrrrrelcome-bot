#!/usr/bin/env python3
# Vrrrr'ELCOME bot!

import collections
import datetime
import logging
import os

import telegram
from telegram import Update
from telegram.ext import Updater, CallbackContext, MessageHandler, Filters, BaseFilter, CommandHandler

TELEGRAM_TOKEN = os.environ['TELEGRAM_TOKEN']
DATA_DIR = os.environ.get('DATA_DIR', '.')
# Sticker: https://t.me/addstickers/vrrrrrelcomebot ðŸ‘‹
WELCOME_STICKER = 'CAACAgEAAxkBAAEDkithyh9aAAFwZEd-9pH21_Xcwom75wMAAhQCAAKi_lBGS70gXpVwuZYjBA'
# Voice: data/welcome.ogg
WELCOME_VOICE = 'AwACAgEAAxkDAAO2YcovGdewbOu3QLRMgwdnQonKBNMAAt4BAAIbp1BGC0iZ8hr2NuUjBA'
WELCOME_CAPTION = "_Vrrrr_'ELCOME\\! ðŸ˜¸"
RECENT_DURATION = datetime.timedelta(minutes=6)
CLEANUP_PERIOD = datetime.timedelta(seconds=37)

# Queue of recently sent messages
RECENT_MESSAGES = collections.deque()

updater = Updater(TELEGRAM_TOKEN)
updater.bot.set_my_commands([('start', 'Start interacting with this bot')], scope=telegram.BotCommandScopeAllPrivateChats())


def command_handler(command, **kwargs):
    """Decorator for registering a `CommandHandler`."""
    def _register(func):
        updater.dispatcher.add_handler(CommandHandler(command, func, **kwargs))
    return _register


def message_handler(filter: BaseFilter, **kwargs):
    """Decorator for registering a `MessageHandler`."""
    def _register(func):
        updater.dispatcher.add_handler(MessageHandler(filter, func, **kwargs))
    return _register


@command_handler('start', filters=Filters.chat_type.private)
def _start(update: Update, _context: CallbackContext):
    """Handle /start command"""
    first_name = update.message.from_user.first_name
    update.message.reply_text(f'Hi {first_name}! To use me, just invite me to your group!')
    update.message.reply_text('I\'ll send this reply to all new users who join the group:')

    logging.info('Sending WELCOME to %s (%d)', update.message.from_user.username, update.message.from_user.id)

    reply_welcome(update.message)


@message_handler(Filters.status_update.new_chat_members)
def _on_new_chat_members(update: Update, _context: CallbackContext):
    """Send "Vrrrrr'elcome!" when a new user joins the chat"""
    logging.info(
        'Sending WELCOME to %s in %s %r (%d)',
        ', '.join(f'{u.username!r} ({u.id})' for u in update.message.new_chat_members),
        update.message.chat.type,
        update.message.chat.title,
        update.message.chat_id)

    for message in reply_welcome(update.message):
        uids = {u.id for u in update.message.new_chat_members}
        RECENT_MESSAGES.append((uids, message))


def reply_welcome(message: telegram.Message):
    """Send WELCOME reply to message"""
    return [
        message.reply_sticker(WELCOME_STICKER),
        message.reply_voice(WELCOME_VOICE, quote=True, caption=WELCOME_CAPTION, parse_mode='MarkdownV2')
    ]


@message_handler(Filters.status_update.left_chat_member)
def _on_left_chat_member(update: Update, _context: CallbackContext):
    """Remove WELCOME if user leaves early"""
    uid = update.message.left_chat_member.id

    for uids, message in RECENT_MESSAGES:
        if uid in uids:
            uids.remove(uid)

        if not uids:
            # All users referenced in this message have left the chat!
            logging.info('Removing message %d (all users left)', message.message_id)
            message.delete()


def cleanup_recent_messages(context):
    """Forget about old messages"""
    now = datetime.datetime.now(datetime.timezone.utc)
    while RECENT_MESSAGES and now - RECENT_MESSAGES[0][1].date > RECENT_DURATION:
        uids, message = RECENT_MESSAGES.popleft()
        for uid in list(uids):
            chat_member = message.chat.get_member(uid)
            if chat_member.status in {telegram.ChatMember.KICKED, telegram.ChatMember.LEFT}:
                uids.remove(uid)

        if not uids:
            # All users referenced in this message have left the chat!
            logging.info('Removing message %d (all users left)', message.message_id)
            message.delete()


def main():
    logging.basicConfig(level=logging.INFO)

    updater.job_queue.run_repeating(cleanup_recent_messages, CLEANUP_PERIOD)

    updater.start_polling()
    updater.idle()


if __name__ == '__main__':
    main()